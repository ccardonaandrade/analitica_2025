---
title: Anal√≠tica de los Negocios
author: Carlos Cardona Andrade
subtitle: Pruebas de Hip√≥tesis
execute:
  freeze: auto
  echo: true
  fig-width: 6
  fig-height: 5
format:
  revealjs: 
   theme: ../slides.scss
   header-includes: |
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"/>
   slide-number: true
   show-slide-number: all
   transition: fade
   progress: true
   multiplex: false
   scrollable: false
   preview-links: false
   hide-inactive-cursor: true
   highlight-style: printing
   pause: true
---
     



## Plan para hoy

1. [Intervalos de Confianza](#intconf)

2. [Intro a Pruebas de Hip√≥tesis](#prueba)

3. [Pruebas de Hip√≥tesis con dos muestras](#prueba2)


# Intervalos de Confianza {#intconf}

## Intervalos de Confianza - Muestra 1 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

library(tidyverse)
library(tidyfinance)
library(scales)
library(patchwork)

price_data <- download_data(
  type = "stock_prices",
  symbols = c("AMZN","META","NVDA","AAPL","TSLA","NFLX", "MSFT"),
  start_date = "2000-01-01",
  end_date = "2023-12-31"
)



netflix_data <-  price_data |>
  filter(symbol=="NFLX" & year(date)>2014)


p1 <- netflix_data |>
  ggplot(aes(x = date, y = adjusted_close)) +
  geom_line(color="darkred") +
  geom_hline(yintercept = mean(netflix_data$adjusted_close, na.rm = TRUE),
             linetype = "dashed", color = "darkblue") + 
  labs(
    x = NULL,
    y = NULL,
    title = "Netflix stock prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  theme_minimal()


# Get the limits from the original netflix_data plot
x_limits <- range(netflix_data$date, na.rm = TRUE)
y_limits <- range(netflix_data$adjusted_close, na.rm = TRUE)


set.seed(123)

netflix_sample <- sample_n(netflix_data, 100)  


result <- t.test(netflix_sample$adjusted_close, conf.level = 0.95)
ci <- result$conf.int

p2 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) +  # Plot the 100 sampled points
  # Add the confidence interval as a shaded ribbon
  geom_ribbon(aes(x = date, ymin = ci[1], ymax = ci[2]), fill = "skyblue", alpha = 0.3, color = NA) +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days with 95% Confidence Interval"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()



result2 <- t.test(netflix_sample$adjusted_close, conf.level = 0.90)
ci2 <- result2$conf.int

p3 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) +  # Plot the 100 sampled points
  # Add the confidence interval as a shaded ribbon
  geom_ribbon(aes(x = date,ymin = ci2[1], ymax = ci2[2]), fill = "skyblue", alpha = 0.3, color = NA) +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days with 90% Confidence Interval"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()


p4 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) + 
  geom_hline(yintercept = mean(netflix_sample$adjusted_close, na.rm = TRUE),
             linetype = "dashed", color = "darkblue") +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days of Netflix Stock Prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p1+p4

```

El precio promedio de las acciones de Netflix fue `r round(mean(netflix_data$adjusted_close, na.rm = TRUE),2)`

## Intervalos de Confianza - Muestra 1 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

p1+p2
```

El intervalo de confianza al 95% es [`r round(ci,2)`]

## Intervalos de Confianza - Muestra 1 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

p1+p3
```

El intervalo de confianza al 90% es [`r round(ci2,2)`]

## Intervalos de Confianza - Muestra 2 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

set.seed(10)

netflix_sample <- sample_n(netflix_data, 100)  


result <- t.test(netflix_sample$adjusted_close, conf.level = 0.95)
ci <- result$conf.int

p2 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) +  # Plot the 100 sampled points
  # Add the confidence interval as a shaded ribbon
  geom_ribbon(aes(x = date, ymin = ci[1], ymax = ci[2]), fill = "skyblue", alpha = 0.3, color = NA) +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days with 95% Confidence Interval"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()



result2 <- t.test(netflix_sample$adjusted_close, conf.level = 0.90)
ci2 <- result2$conf.int

p3 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) +  # Plot the 100 sampled points
  # Add the confidence interval as a shaded ribbon
  geom_ribbon(aes(x = date, ymin = ci2[1], ymax = ci2[2]), fill = "skyblue", alpha = 0.3, color = NA) +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days with 90% Confidence Interval"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()


p4 <- ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) + 
  geom_hline(yintercept = mean(netflix_sample$adjusted_close, na.rm = TRUE),
             linetype = "dashed", color = "darkblue") +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days of Netflix Stock Prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p1+p4

```



## Intervalos de Confianza - Muestra 2 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

p1+p2
```

El intervalo de confianza al 95% es [`r round(ci,2)`]


## Intervalos de Confianza - Muestra 2 {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 10

p1+p3
```

El intervalo de confianza al 90% es [`r round(ci2,2)`]


# Intro a Pruebas de Hip√≥tesis {#prueba}


## Ejemplo: Precio de la acci√≥n de Netflix 2015-2023 {.medium}

- Retomemos el ejemplo de la muestra de los 100 d√≠as de precios de la acci√≥n de Netflix


```{r}
#| echo: true
#| fig-align: center
#| fig-width: 10

library(tidyfinance)

# Descargamos los datos de 2015 a 2023
netflix_data <- download_data(
  type = "stock_prices",
  symbols = "NFLX",
  start_date = "2015-01-01",
  end_date = "2023-12-31"
)


# Establecemos la semilla
set.seed(10)

# Tomamos la muestra de 100 d√≠as
netflix_sample <- sample_n(netflix_data, 100)  
```



## ¬øC√≥mo es la distribuci√≥n de esos datos?

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 8

ggplot(netflix_sample, aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) + 
  geom_hline(yintercept = mean(netflix_sample$adjusted_close, na.rm = TRUE),
             linetype = "dashed", color = "darkblue") +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days of Netflix Stock Prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()
```


## Ejemplo: N√∫mero de horas que estudian Anal√≠tica {.medium}

- Uno de sus colegas cree que el precio promedio de la acci√≥n de Netflix fue 310

- El precio promedio de la acci√≥n para la muestra es `r round(mean(netflix_sample$adjusted_close, na.rm = TRUE),2)` y la desviaci√≥n est√°ndar es `r round(sd(netflix_sample$adjusted_close, na.rm = TRUE),2)`

- ¬øSon estos datos suficientes para probar que el precio de la acci√≥n es mayor al precio que su considera fue el real durante ese periodo?


## Hip√≥tesis {.medium}

- `Poblaci√≥n`: todos los d√≠as de 2015 a 2023
- El `par√°metro de inter√©s` $\color{purple}\mu$ es el precio promedio de la acci√≥n en *todos* los d√≠as de ese per√≠odo
- Hay dos explicaciones de por qu√© la media muestral es mayor
que el precio estimado por su colega:
  1. La media real de la poblaci√≥n es diferente.
  2. La media real de la poblaci√≥n es 310, y la diferencia entre la media real de la poblaci√≥n y la media de la muestra se debe simplemente a la variabilidad natural del muestreo.
- $\color{blue}{H_0}$ $: \mu = 310$ (El precio promedio de la acci√≥n es 310)
- $\color{blue}{H_A}$ $: \mu > 310$ (El precio promedio de la acci√≥n es $>$ 310)


## Maneras incorrectas de establecer las hip√≥tesis {.medium}

- $H_0$ y $H_A$ **SIEMPRE** se expresan en t√©rminos de par√°metros de poblaci√≥n, no de estad√≠sticas de muestra.
- Ni:

$$H_0 : \bar{x} = 310, \quad H_A : \bar{x} > 310$$

- ni:

$H_0 :$ el n√∫mero de horas de estudio `en la muestra` es 310

$H_A :$ el n√∫mero de horas de estudio `en la muestra` es 310

son correctas. 


## Maneras incorrectas de establecer las hip√≥tesis {.medium}

Las hip√≥tesis son:

$$H_0 : \mu = 310, \quad H_A : \mu > 310$$
Tambi√©n siempre **especif√≠quen claramente** qu√© es $\mu$

e.g., $\mu$ es el precio promedio de la acci√≥n de Netflix entre 2015 y 2023


## El estad√≠stico de la prueba {.medium}

Por el TLC, bajo $H_0:\mu=310$, la distribuci√≥n de la media muestral es:

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true

# Define the x-axis range and normal distribution
x <- seq(-4, 4, length = 1000)
y <- dnorm(x)

# Create a data frame
df <- data.frame(x = x, y = y)

# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(0, 2.06),
                         labels = c(expression(mu == 310), expression(bar(x) == 342))) +
  labs(x = "", y= "") +
  geom_vline(xintercept = 2.06, linetype = "dashed", color = "darkblue") +  # Vertical dashed line
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank())

```


Para medir qu√© tan *inusual* es la media muestral observada $\bar{x}=342$ en relaci√≥n con su distribuci√≥n muestral, la estad√≠stica de prueba que usamos es el z-score.


## El estad√≠stico de la prueba {.medium}

  $$Z=\dfrac{\bar{x}-\mu}{\dfrac{s_x}{\sqrt{n}}}=\dfrac{342-310}{\dfrac{154.71}{\sqrt{100}}}\approx2.06$$

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(0, 2.06),
                         labels = c(expression(mu == 0), expression(Z == 2.06))) +
  labs(x = "", y= "") +
  geom_vline(xintercept = 2.06, linetype = "dashed", color = "darkblue") +  # Vertical dashed line
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank())

```

## El estad√≠stico de la prueba {.medium}


::: {.columns}
::: {.column width=50%}

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x < 1.96, x, NA)), fill = "white", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 1.96, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(1.96),
                         labels = c( expression(Z^{"*"}))) +
  labs(x = "", y= "") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()) + 
  annotate("text", x = 0, y = 0.12, label = expression("No se rechaza H0"), size = 6) +
  annotate("text", x = 2.8, y = 0.08, label = expression("Regi√≥n"), size = 6, color = "darkred") +
  annotate("text", x = 3, y = 0.06, label = expression("de Rechazo"), size = 6, color = "darkred") 

```
:::

::: {.column width=50%}

- Las medias muestrales que son probables de obtener si $H_0$ es cierta son las medias muestrales cercanas a la hip√≥tesis nula.

- Las medias muestrales que son poco probables de obtener si $H_0$ es cierta son aquellas lejanas a la hip√≥tesis nula

:::
:::



## ¬ø Qu√© significa ‚Äúalta‚Äù y ‚Äúbaja‚Äù probabilidad? {.medium}


- Esto se establece a partir de una probabilidad espec√≠fica, la cual se conoce como nivel de significancia (se denota con $\alpha$), para la prueba de hip√≥tesis.

- El valor $\alpha$ es una probabilidad peque√±a que se utiliza para identificar muestras de poca probabilidad o inusuales.

- Por convenci√≥n, los valores $\alpha$
 m√°s comunes son 0,05 o 0,01
 
- Por ejemplo, si usamos $\alpha$ = 0,05, separamos el 5% de las medias m√°s improbables (valores extremos) del 95% de las medias muestrales m√°s probables (valores centrales).


## Regi√≥n y Z-scores cr√≠ticos {.medium}

- Los valores extremos que son poco probables, definidos por el nivel de significancia, constituyen lo que se conoce como **regi√≥n cr√≠tica**.

- Estos valores son inconsistentes con la hip√≥tesis nula. Tambi√©n se pueden interpretar como valores muestrales que proveen evidencia convincente de que el tratamiento/condici√≥n tienen alg√∫n efecto.

- Al igual que con los intervalos de confianza, para determinar la ubicaci√≥n exacta de los l√≠mites se utilizan el $\alpha$ y la distribuci√≥n normal para encontrar el z-score cr√≠tico.

## ¬øCu√°l es nuestro $z^*$ cr√≠tico? {.medium}

Si nuestro $\alpha$ = 0.05, el z-cr√≠tico ser√° 1.64 de acuerdo a la tabla de la distribuci√≥n normal

```{r}
#| echo: true
#| fig-align: center
#| fig-width: 10
qnorm(0.95, mean = 0, sd = 1)
```

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x < 1.64, x, NA)), fill = "yellow", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 1.64, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(1.64),
                         labels = c( expression(Z^{"*"}==1.64))) +
  labs(x = "", y= "") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()) 

```


## ¬øCu√°l es el resultado de la prueba? {.medium}

La media muestral se ubica en la regi√≥n cr√≠tica!

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x < 1.64, x, NA)), fill = "yellow", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 1.64, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(1.64),
                         labels = c( expression(Z^{"*"}==1.64))) +
  labs(x = "", y= "") +
  geom_vline(xintercept = 2.06, linetype = "dashed", color = "darkblue") +  # Vertical dashed line
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank())  + 
  annotate("text", x = 2.8, y = 0.25, label = expression(Z==2.06), size = 6, color = "darkblue")

```


## ¬øCu√°l es el resultado de la prueba? {.medium}

$$Z=2.06>1.64=Z_{\alpha=0.05}$$

- [Rechazamos $H_0$]{.marker-hl}

- Los datos proveen evidencia convincente de que el precio promedio de las acciones de Netflix entre 2015 y 2023 es mayor a 310

- En otras palabras, la media muestral es **estad√≠sticamente diferente** de 310

## Prueba de hip√≥tesis a dos colas {.medium}

Si quisieramos saber si los datos proveen evidencia consistente que el precio promedio de las acciones de Netflix es `diferente` que el 310 descrito por el colega, la hip√≥tesis alternativa cambiar√≠a:


$$H_0: \mu = 310$$

$$H_0: \mu \neq 310$$

## Prueba de hip√≥tesis a dos colas {.medium}

Si nuestro $\alpha$ = 0.05, el z-cr√≠tico ser√° 1.96 de acuerdo a la tabla de la distribuci√≥n normal

```{r}
#| echo: true
#| fig-align: center
#| fig-width: 10
qnorm(0.975, mean = 0, sd = 1)
```


```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x >= -1.96 & x <= 1.96, x, NA)), fill = "white", alpha = 0.5) +
  geom_area(aes(x = ifelse(x < -1.96, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 1.96, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) + 
  scale_x_continuous(breaks = c(-1.96, 1.96),
                         labels = c(expression(Z^{"*"}==-1.96), expression(Z^{"*"}==1.96))) +
  labs(x = "", y= "") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank())+ 
  annotate("text", x = 0, y = 0.12, label = expression("No se rechaza H0"), size = 6) +
  annotate("text", x = 2.8, y = 0.08, label = expression("Regi√≥n"), size = 6, color = "darkred") +
  annotate("text", x = 3, y = 0.06, label = expression("de Rechazo"), size = 6, color = "darkred") +
  annotate("text", x = -2.8, y = 0.08, label = expression("Regi√≥n"), size = 6, color = "darkred") +
  annotate("text", x = -3, y = 0.06, label = expression("de Rechazo"), size = 6, color = "darkred")

```


## Prueba de hip√≥tesis a dos colas {.medium}

- En este caso, una media muestra $\bar{x}$ mucho menor a 310 tambi√©n ser√≠a evidencia en favor de $H_A$

- Como $Z=2.06>1.96=Z_{\alpha=0.05}$, seguimos rechazando $H_0$


```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x >= -1.96 & x <= 1.96, x, NA)), fill = "yellow", alpha = 0.5) +
  geom_area(aes(x = ifelse(x < -1.96, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 1.96, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) +
  geom_vline(xintercept = 2.06, linetype = "dashed", color = "darkblue") +  # Vertical dashed line
  scale_x_continuous(breaks = c(-1.96, 1.96),
                         labels = c(expression(Z^{"*"}==-1.96), expression(Z^{"*"}==1.96))) +
  labs(x = "", y= "") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank())+ 
    annotate("text", x = 2.8, y = 0.25, label = expression(Z==2.06), size = 6, color = "darkblue")


```

## IC y prueba de hip√≥tesis a dos colas {.medium}

En una prueba de hip√≥tesis a dos colas:

$$H_0:\mu=\mu_0 \quad versus \quad H_A:\mu\neq\mu_0$$

No rechazar la hip√≥tesis nula es equivalente a que $\mu_0$ est√© dentro del intervalo de confianza del $100(1-\alpha)$\% para $\mu$. Es decir:


  $$\bar{x}-z^*\dfrac{s}{\sqrt{n}}<\mu_0<\bar{x}+z^*\dfrac{s}{\sqrt{n}}$$

## IC y prueba de hip√≥tesis a dos colas {.medium}



::: {.columns}
::: {.column width=25%}
Retomemos:

$$H_0: \mu = 310$$

$$H_0: \mu \neq 310$$
Rechazamos cuando:

$$\alpha=0.1\text{?}$$

$$\alpha=0.05\text{?}$$

$$\alpha=0.01\text{?}$$



:::

::: {.column width=75%}

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true
#| fig-width: 6

# Given data
null_mean <- 310
sd_sample <- sd(netflix_sample$adjusted_close, na.rm = TRUE)
n_sample <- length(netflix_sample$adjusted_close)
se <- sd_sample / sqrt(n_sample)

# Confidence intervals
z_values <- c(1.645, 1.96, 2.576)  # Critical values for 90%, 95%, 99%
levels <- c("90%", "95%", "99%")
lower_bounds <- null_mean - z_values * se
upper_bounds <- null_mean + z_values * se

# Create data frame
ci_df <- data.frame(
  Level = levels,
  Lower = lower_bounds,
  Upper = upper_bounds
)

# Plot
ggplot(ci_df, aes(x = Level, ymin = Lower, ymax = Upper)) +
  geom_linerange(size = 1.5, aes(color = Level)) +  # Plot confidence intervals
  geom_point(aes(y = Lower), size = 3) +  # Lower bound points
  geom_point(aes(y = Upper), size = 3) +  # Upper bound points
  geom_point(aes(y = null_mean, fill = Level), size = 3, shape = 21) +  # Dot for 310
  geom_hline(aes(yintercept = 342, linetype = "mean"), 
             color = "black", size = 1) +  # Dashed line for null hypothesis
  scale_linetype_manual(name = "", values = "dashed", 
                        labels = expression(bar(x) == 342)) +  # Customize legend
  labs(title = expression("Confidence Interval for " ~ mu ~ "= 310"),
       x = "Confidence Level",
       y = "Netflix Stock Price",
       color = "Confidence Level") + 
  theme_minimal() +
  theme(legend.position = "right") +
  guides(fill = "none")

```

:::
:::


## p-value {.medium}




::: {.columns}
::: {.column width=50%}

- El z-score tiene una probabilidad asociada dada la forma de la distribuci√≥n normal.

- Por ende, la decisi√≥n de una prueba de hip√≥tesis puede basarse tanto en el z-score como en su probabilidad asociada (p-value).


:::

::: {.column width=50%}

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Plot the normal distribution with highlighted regions
ggplot(df, aes(x = x, y = y)) +
  geom_area(aes(x = ifelse(x < 2.06, x, NA)), fill = "white", alpha = 0.5) +
  geom_area(aes(x = ifelse(x > 2.06, x, NA)), fill = "darkred", alpha = 0.5) +
  geom_line(color = "black", size = 1) +
  scale_x_continuous(breaks = c(2.06),
                         labels = c( expression(Z==2.06))) +
  labs(x = "", y= "") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()) 

```

:::
:::


```{r}
#| echo: true
#| fig-align: center
#| fig-width: 10
pnorm(2.06, mean = 0, sd = 1, lower.tail = FALSE)
```


## p-value {.medium}

- Para nuestro $z=2.06$, sabemos que p‚àívalue=0.019

- Si $\alpha$=0.05, se rechaza la hip√≥tesis nula dado que 0.019<0.05

- Esto sucede para un nivel de significancia del 5%, ¬øqu√© sucede si este cambia a 1%?

- El p-value es la probabilidad de observar los estad√≠sticos de los datos ($\bar{x}$=310) si la hip√≥tesis nula fuera cierta.


## Resumen - Prueba de hip√≥tesis {.medium}

::: {.columns}
::: {.column width=50%}

1. Establezca las hip√≥tesis
    - $H_0:\mu=\mu_o$
    - $H_A:\mu$< o > o $\neq\mu_o$
    
2. Revise los supuestos y condiciones
    - Independencia
    - Normalidad: $n>30$


:::

::: {.column .fragment width=50%}

3. Calcular el z-score y el p-value (dibujen la gr√°fica!)

$$Z_{\bar{X}}=\dfrac{\bar{X}-\mu_0}{s_X/\sqrt{n}}$$

4. Tomen una decisi√≥n:

    - Si $Z_{\bar{X}} \geq Z_{\alpha} \rightarrow p \leq \alpha$ : Se rechaza $H_0$
    - Si $Z_{\bar{X}} < Z_{\alpha} \rightarrow p > \alpha$ : No se rechaza $H_0$
    
:::
:::


# Pruebas de Hip√≥tesis con dos muestras {#prueba2}

## Prueba de hip√≥tesis con dos muestras {.medium}

:::incremental

- ¬øLas empresas que cotizan en NYSE tienen mayores rendimientos promedio de acciones que las que cotizan en NASDAQ?

- ¬øLas tasas de inter√©s de las hipotecas ofrecidas por el banco A son m√°s bajas que las ofrecidas por el banco B?

- ¬øLos salarios promedio de los empleados en empresas tecnol√≥gicas son diferentes de los de las empresas manufactureras?

- El objetivo ahora es comparar las medias (o alguna cantidad) $\mu_1$ y $\mu_2$ de dos poblaciones

:::

## Muestras independientes y relacionadas {.medium}



- Las hip√≥tesis en este caso son:

  - $H_0:\mu_A-\mu_B=0$
  - $H_A:\mu_A-\mu_B\neq0$
  
:::incremental
  
- Las muestras pueden ser:

    1. Independientes: medici√≥n de unidades en distintos grupos.

    2. Relacionadas: medici√≥n de la misma unidad antes y despu√©s de alguna intervenci√≥n/suceso. 

:::

## Ejemplo: Apple and Amazon stock prices {.medium}

- Volvamos a los datos de precios de las acciones en el per√≠odo 2015-2023.

- Seleccionemos una muestra de 100 d√≠as de los precios de Apple y Amazon.

- Bas√°dos en la muestra, ¬øfueron iguales los precios promedio de estas dos compa√±√≠as durante este per√≠odo?
    

## Ejemplo: Apple and Amazon stock prices {.medium}

```{r}
#| echo: true

prices_data <- download_data(
  type = "stock_prices",
  symbols = c("AAPL", "AMZN"),
  start_date = "2015-01-01",
  end_date = "2023-12-31"
)

# Establecemos la semilla para reproducibilidad
set.seed(123)

# Tomamos una muestra de 100 d√≠as para cada empresa
prices_sample <- prices_data |>
  group_by(symbol) |>
  sample_n(100)

# Verificamos la muestra
nrow(prices_sample)

```



## Ejemplo: Apple and Amazon stock prices {.medium}

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 8


# Get the limits from the original netflix_data plot
x_limits <- range(prices_data$date, na.rm = TRUE)
y_limits <- range(prices_data$adjusted_close, na.rm = TRUE)

apple_mean <- prices_data |> 
  filter(symbol == "AAPL") |> 
  summarise(mean_price = mean(adjusted_close, na.rm = TRUE)) |> 
  pull(mean_price)

amazon_mean <- prices_data |> 
  filter(symbol == "AMZN") |> 
  summarise(mean_price = mean(adjusted_close, na.rm = TRUE)) |> 
  pull(mean_price)

p1 <- prices_data |>
  filter(symbol == "AAPL")  |>
  ggplot(aes(x = date, y = adjusted_close)) +
  geom_line(color="darkred") +
  geom_hline(yintercept = apple_mean,
             linetype = "dashed", color = "darkblue") + 
  labs(
    x = NULL,
    y = NULL,
    title = "Apple stock prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p2 <- prices_data |>
  filter(symbol == "AMZN")  |>
  ggplot(aes(x = date, y = adjusted_close)) +
  geom_line(color="darkred") +
  geom_hline(yintercept = amazon_mean,
             linetype = "dashed", color = "darkblue") + 
  labs(
    x = NULL,
    y = NULL,
    title = "Amazon stock prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p1+p2

```


## Ejemplo: Apple and Amazon stock prices {.medium}


```{r}
#| echo: false
#| fig-align: center
#| fig-width: 8


apple_mean <- prices_sample |> 
  filter(symbol == "AAPL") |> 
  summarise(mean_price = mean(adjusted_close, na.rm = TRUE)) |> 
  pull(mean_price)

amazon_mean <- prices_sample |> 
  filter(symbol == "AMZN") |> 
  summarise(mean_price = mean(adjusted_close, na.rm = TRUE)) |> 
  pull(mean_price)


p1 <- prices_sample |>
  filter(symbol == "AAPL") |>
ggplot(aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) + 
  geom_hline(yintercept = apple_mean,
             linetype = "dashed", color = "darkblue") +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days of Apple Stock Prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p2 <- prices_sample |>
  filter(symbol == "AMZN") |>
ggplot(aes(x = date, y = adjusted_close)) +
  geom_point(color = "darkgreen", alpha = 0.6) + 
  geom_hline(yintercept = amazon_mean,
             linetype = "dashed", color = "darkblue") +
  labs(
    x = NULL,
    y = NULL,
    title = "100 Sampled Days of Amazon Stock Prices"
  ) + 
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(limits = x_limits) +  # Apply the same x-axis limits as the original plot
  coord_cartesian(ylim = y_limits) +  # Apply the same y-axis limits as the original plot
  theme_minimal()

p1+p2

```

## Prueba de hip√≥tesis en R {.medium}

  $$H_0:\mu_{apple}-\mu_{amazon}=0$$
  
  $$H_0:\mu_{apple}-\mu_{amazon}\neq0$$
    
Nuestra hip√≥tesis nula es que no existe diferencia en el precio promedio de las acciones de ambas empresas durante el periodo.

## Prueba de hip√≥tesis en R {.medium}

Nuevamente usamos el comando `t.test()`:

```{r}
#| echo: true

# Calculemos el test
test_resultado <- t.test(adjusted_close ~ symbol, data = prices_sample, conf.level = 0.95)
test_resultado

```

Observen que el intervalo de confianza no incluye al cero. Por lo tanto **Rechazamos $H_0$**

## Prueba de hip√≥tesis en R {.medium}

¬øCu√°nto es el p-value?¬øEs $p<\alpha$?

```{r}
#| echo: true
test_resultado$p.value

test_resultado$p.value<0.05

```


## IC con distintos niveles de confianza {.medium}

```{r}
#| fig.align: 'center'
#| echo: false
#| eval: true


# Function to compute confidence intervals and mean
compute_ci <- function(data, symbol, levels = c(0.90, 0.95, 0.99)) {
  ci_list <- lapply(levels, function(conf) {
    test_result <- t.test(data$adjusted_close, conf.level = conf)
    data.frame(
      Symbol = symbol,
      Level = paste0(conf * 100, "%"),
      Lower = test_result$conf.int[1],
      Upper = test_result$conf.int[2],
      Mean = mean(data$adjusted_close, na.rm = TRUE)  # Compute the mean
    )
  })
  bind_rows(ci_list)
}

# Filter data for Apple and Amazon
apple_data <- prices_sample |> filter(symbol == "AAPL")
amazon_data <- prices_sample |> filter(symbol == "AMZN")

# Compute confidence intervals and means for both companies
ci_apple <- compute_ci(apple_data, "Apple")
ci_amazon <- compute_ci(amazon_data, "Amazon")

# Combine data
ci_df <- bind_rows(ci_apple, ci_amazon)

# Plot confidence intervals with mean points
ggplot(ci_df, aes(x = Level, ymin = Lower, ymax = Upper, color = Symbol)) +
  geom_linerange(size = 1.5, position = position_dodge(width = 0.3)) +  
  geom_point(aes(y = Lower), size = 3, position = position_dodge(width = 0.3), shape = 15) +  # Lower bound
  geom_point(aes(y = Upper), size = 3, position = position_dodge(width = 0.3), shape = 15) +  # Upper bound
  geom_point(aes(y = Mean), size = 3, position = position_dodge(width = 0.3), shape = 16) +   # Mean point
  labs(
    title = "Confidence Intervals for Apple and Amazon Stock Prices",
    x = "Confidence Level",
    y = "Stock Price",
    color = "Company"
  ) + 
  theme_minimal()
```


## Errores Tipo I y II {.medium}

<div style="margin-top: 100px;"></div>


::: {.tbl-classic .tbl-larger .center-text}


|                  | **Decisi√≥n: Rechaza $H_0$** | **Decisi√≥n: No Rechazar $H_0$** |
|------------------|------------------------------|-------------------------------------|
| **$H_0$ es verdadera**  | Error Tipo I (Falso Positivo) |            üòä                       |
| **$H_0$ es falsa** |            üòä                 | Error Tipo II (Falso Negativo)     |

:::


- (Casi) Nunca sabremos si $H_0$ o $H_A$ son verdaderas, pero se necesita considerar todas las posibilidades
